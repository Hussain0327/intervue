name: Post-Deploy Smoke Test

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: "Base URL of the deployed API"
        required: true
        default: "https://intervue-api.onrender.com"

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    env:
      API_URL: ${{ inputs.api_url }}
    steps:
      - name: Health check
        run: |
          echo "Checking $API_URL/health ..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$API_URL/health")
          if [ "$STATUS" != "200" ]; then
            echo "Health check failed with status $STATUS"
            exit 1
          fi
          echo "Health check passed (200)"

      - name: Readiness check
        run: |
          echo "Checking $API_URL/ready ..."
          BODY=$(curl -sf "$API_URL/ready")
          echo "$BODY"
          echo "$BODY" | grep -q '"status":"ready"' || {
            echo "Readiness check failed"
            exit 1
          }
          echo "Readiness check passed"

      - name: CORS preflight
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X OPTIONS \
            -H "Origin: https://intervue.vercel.app" \
            -H "Access-Control-Request-Method: POST" \
            "$API_URL/health")
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "204" ]; then
            echo "CORS preflight failed with status $STATUS"
            exit 1
          fi
          echo "CORS preflight passed ($STATUS)"

      - name: Auth enforcement
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "$API_URL/resume/parse")
          if [ "$STATUS" != "401" ] && [ "$STATUS" != "403" ]; then
            echo "Expected 401/403 but got $STATUS â€” auth may not be enforced"
            exit 1
          fi
          echo "Auth enforcement passed ($STATUS)"
